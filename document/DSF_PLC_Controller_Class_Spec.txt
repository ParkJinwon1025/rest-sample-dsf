# DSF_PLC_Controller_Class_Spec

# 수정이력
    2024-04-23, v0.1, 최초작성, 김구정
    2024-04-23, v0,2, J/F PLC 도 동일 기능 필요, 김구정
    2024-05-07, v0.3, MPLC 클래스 / 함수 상세 추가. 김구정
    2024-05-09, v0.4, DSF 메모리맵 특징 부여 클래스 함수 상세 설계, 김구정
    2024-05-13, v0.5, DSF 메모리맵 특징 부여 클래스 함수 상세 설계 내용 업데이트, 김구정
    2024-05-13, v0.6, MCStatusWord class 관련 정보 수정, 김구정

# ver0.5


[목차]
1. 추가 프로젝트
2. 클래스 목록
3. public class MELSEC 상세 스펙
4. class MMFDriver 상세 스펙
5. public class MemoryMapItem 상세 스펙
6. public static class MelsecUtil 상세 스펙
7. public partial class MCStatusWord : UserControl  상세 설계
8. public static class GlobalObject
9. public static class EnumerationExtensions
10. DSF 용 각종 CMD_PLC 처리 로직
11. public partial class DSFPLC : UserControl 상세 스펙 
12. public partial class DSFPLC : UserControl 상세 설계


1. 추가 및 수정 프로젝트
    1> DSFScheduler : 추가
    2> MPLC : DSF PLC User Control 추가
        2.1> DSFPLC.cs
        2.2> DSFPLC_Biz.cs 
        2.3> DSFPLC_CMD.cs 


2. 클래스 목록
    1> public partial class DSFPLC : UserControl
        1.1> UI 관련 컨트롤 클래스
        1.2> 각종 CMD_PLC 처리 로직 추가
    2> public enum BIZ_TABLES
        2.1> 비즈로직 테이블과 SP 들 정의 열거상수
        2.2> 사용하는 테이블/SP 의 사용법에 해당하는 각종 데이터 클래스


3. public class MELSEC 상세 스펙
    1> public bool Open(int comm_profile_no)    // plc open
    2> public bool Close()  //  plc close 
    3> public bool ReadWord(string szAddress, out short word)   // read mm buffer
    4> public bool WriteWord(string szAddress, short word)      // write mm buffer
    5> public bool ReadBlock(string szAddress, int wordcnt, ref short lpwords)  // read block mm buffer
    6> public bool WriteBlock(string szAddress, int wordcnt, short[] lpwords)   // write block mm buffer 
    
    7> private void StartAliveCheckThread()     // alive check start 
    8> private void StopAliveCheckThread()      // alive check stop 
    9> private void AliveCheck_SameWord()       // same memory alive check 
    10> private void AliveCheck()               // diff memory alive check 

4. class MMFDriver 상세 스펙    // for SIM_MODE 
    1> public MMFDriver(string name, int size)  // ctro 
    2> public bool Open(out string errorText)
    3> public void Close()
    4> public bool Read(string szAddress, out short word)
    5> public bool ReadBlock(string szAddress, int wordcnt, ref short lpwords)
    6> public bool WriteWord(string szAddress, short word)
    7> public bool WriteBlock(string szAddress, int wordcnt, short[] lpwords)
    8> private bool ReadMMF(int startAddess, int length, out byte[] value)
    9> private bool WriteMMF(int startAddess, byte[] value)
    10> private int GetMMFAddress(string szAddress)
    11> private bool GetIsHexadecimal(string deviceType)


5. public class MemoryMapItem 상세 스펙 // Class for holding DATA read from PLC (Not for WRITING!!!)
    1> public string AsString()     //  bytes to string 
    2> public string AsStringWord() //  1Word 상위 1byte에만 값이 있는 word block
    3> public short GetWord()
    4> public string GetBlockString(int index, int reqByteCount)        // Cell별 CellID를 Loop돌면서 가져와야 할것 같다. --// DSF 에서는 사용 여부 검토
    5> public bool SetWord(short value)
    6> public bool SetString(string value)
    7> public bool SetStringAt(string value, int valueWordCount, int index)
    8> public bool BufferToFld(short[] buffer, int bufferlen)
    9> public bool FldToBuffer(short[] buffer, int bufferlen)
    10> public string GetDebugString()
    11> public MemoryMapItem(int seq, string name, string addr, int wordcnt, int offset)    // ctro 


6. public static class MelsecUtil 상세 스펙
    1> public static bool IsHexDevice(char device)  // DSF 는 zr 디바이스 이다.
    2> public static int AddressBase(char device)
    3> public static int AddressBase(string address)


7. public partial class MCStatusWord : UserControl  상세 스펙   // Word 단위의 Bit memorMap user control 
    1> public enum BitMeaning 수정 필요.
        .1> EQPStatus : 협의 필요
        .2> aliveBIt : Bit0
        .3> EQPPower : Bit0
        .4> 강제 셀배출요청 ( CellOUtReq ) : Bit0
        .5> 투입Tray의 Cell정보요청 ( CellInfoReq ) : Bit0 
        .6> RecipeID 검증요청 ( RecipeIDValidReq ) : Bit0 
        .7> Grade 요청 ( GradeReq ) : Bit0 
        .8> Data Down : Bit0 
    
        .9> RecipeID OK Confirm : Bit0 
        .10> 강제 셀 배출 Confirm ( CellOutConfirm ) : Bit0
        .11> Host has Touble : Bit0
        .12> Data Down : Bit0
        .13> Recipe 갱신 요청 ( RecipeRedownReq ) : Bit0

    2> MCStatusWord.BuildBitArray() : 참고함수, Bit0 ~ BitF 까지 Word(16Bits) 를 구성


8. public static class GlobalObject     //  Log level 정의 클래스,
    1> 검토 수정 할 사항 없음.


9. public static class EnumerationExtensions        //  Enum Flag 사용 시, Has, Remove 등을 사용하기 위한 Extension 이다.
    1> 검토 수정 할 사항 없음.


10. DSF 용 각종 CMD_PLC 처리 로직 //    DSL Bit Type 에 따라 달라질 수 있다. 김구정, 2024-05-07
    1> private void DoCommand()  // bit chenage event 에 따라 호출되는 중요 작업 함수.   
    2> private void CMD_PowerOff()
    3> private void CMD_PowerOn()
    4> private void CMD_Trouble()
        -> CMD_Alarm() 으로 대체 되어야 함.
    5> private void CMD_TroubleReset()
        -> CMD_AlarmReset() 으로 대체 되어야 함.
    6> private void CMD_ModeOffline()
    7> private void CMD_ModeOnline()
    8> private void CMD_TrayOn()
        -> CMD_CellOn()  으로 대체 되어야 함.
    9> private void CMD_TrayOff()
        -> CMD_CellOff()  으로 대체 되어야 함.
    10> private void CMD_Running()
    11> private void CMD_DataReq()
    12> private void CMD_JobEnd()
    13> private void CMD_JobEndConfirm()
    14> private void ClearHostPLC()
    15> private void CMD_DataReq_Bypass(string TrayID)
    16> private void CMD_DataReq_Trouble(string trayid, HPC_TROUBLE_CODE troubleCode)
        -> CMD_DataReq_Alarm() 으로 대체 ??, Host Trouble 일 경우 ?? 분류 안됨.
    17> private void CMD_DataReq_Normal(TABLE_SELECT_tTrayCurr tray, List<string> CellIDs)
    18> 기타 필요한 CMD 들...
        .1> Recipe 처리
        .2> 실측 데이터 처리 
        .3> 강제배출 처리
        .4> alive check 방식 변경 필요.
        .5> 그외 다수 일듯...


11. public partial class DSFPLC : UserControl 상세 스펙 
    1> public DSFPLC()  // ctor 
    2> private MCStatus UpdateFlag(MCStatus status, BitMeaning changed, bool bitOn)
        // PLC 측 비트 변경시 UI flag를 업데이트 하는 함수.
    3> private void InitMemoryMap()
        // 메모리맵 m 의 실제 주소 초기화 함수.
    4> void UsePLC(bool bUse)
        // 실제 PLC 사용 여부 를 확인 하여 연동하는 함수.
    5> private void PLC_READER_ThreadFunc()
        // word 타입 데이터 읽기용 쓰레드 함수.
    6> private void UpdateUI_PLC()
    7> void AliveCheck()
    8> void PLC_Write_Word(MELSEC plc, MemoryMapList mlist, int index)
    9> private void DSFPLC_Load(object sender, EventArgs e) // form load event 
    10> private void CollectDSFOutPLCObjects()
    11> private void DSFPLC_FormClosing(object sender, FormClosingEventArgs e)  // form closing event 
    12> private void ResetUseCheckbox() // UI checkbox handler
    13> private void InitStatusWords()  // mm init 
    14> Enums ...   // 대체로 DSF mm 에 따라 변경 되어야 한다. 
        .1> public enum MCStatus
        .2> ublic enum HostStatus
        .3> public enum CMD_Grader
        .4> enum BUFFER_FLD_MC
        .5> enum BUFFER_FLD_HOST
        .6> 그외 필요에 따라 추가...


12. public partial class DSFPLC : UserControl 상세 설계
    0> 특징
        .1> bit type 데이터의 0번 비트 활용한다.
        .2> EQPStatus 필드의 값은 Clever 와 협의가 필요하다
            
    1> DSFPLC.MemoryMapList : 수정여부 높음.
        .1> EQ : mapMC_
            - Bit Type : EQPStatus, aliveBIt, EQPPower, 강제 셀배출요청, 투입Tray의 Cell정보요청
                        , RecipeID 검증요청, Grade 요청, Data Down.
            - Data Type : Alarm Code (420 Word), 투입 Tray ID BCR (16 ASCII), 배출 Tray ID BCR (16 ASCII)
                        , NG Tray ID BCR (16 ASCII), Cell ID BCR #1 (16 ASCII), Cell ID BCR #2 (16 ASCII)
                        , Cell ID BCR #3 (16 ASCII), Cell ID BCR #4 (16 ASCII), RecipeID (16 ASCII)
                        , Step ( 1 int) - 1~9 까지 (기본값 : 1), Good Cell ( 1 ASCII) - (G : Good, B : Bad Pin, N : Non Cell)
                        , IR ( 2 FLOAT), OCV ( 2 FLOAT), Pressure ( 2 Float), 온도 ( 2 Flaot), 절연저항 ( 2 int)
                        , 셀무게 ( 2 Float), 비전검사 score ( 2 Float).

        .2> Host : mapHost_
            - Bit Type : RecipeID OK Confirm, 강제 셀 배출 Confirm, Host has Touble, Data Down, Recipe 갱신 요청.
            - Data Type : Host Trouble Code ( 2 Int), Host Message ( 100 ASCII), 셀 Grade ( 1 ASCII), RecipeID ( 16 ASCII)
                        , 비전AvgMax ( 2 Float), 비전AvgMin ( 2 Float), 셀무게AvgMax ( 2 Float), 셀무게AvgMin ( 2 Float)
                        , OcvPinLimitCnt ( 2 Int), OcvPinBadUpper ( 2 Float), OcvPinBadLower ( 2 Float), OcvPinBadDelta ( 2 Float)
                        , OcvIrBadUpper( 2 Float), OcvIrBadLower ( 2 Float), Pressure ( 2 Float), Temp ( 2 Float)
                        , 투입 Tray CellIDs ( 16 ASCII * 20 개 = 320 ASCII ), 투입 Tray CellGrades ( 1 ASCII * 20 개 = 20 ASCII)

    2> DSFPLC.CMD_XXX 함수 그룹 : 각종 필요 로직 cmd 들 xxx는 이름이다.
        .0> bitType 필드는 addr 에 상시접근 인스턴스 필요함. 

        .1> CMD_Chk_EQPStatus() : EQPStatus bit 를 확인하여, 현재 설비 상태 확인.
        .2> CMD_Chk_EQPPower() : 설비 전원 온오프 확인.
        .3> CMD_Cell_Out_Off() : 강제 셀 배출 요청 처리.
        .4> CMD_InTray_Off() : 투입 Tray의 Cell 정보 요청 처리
        .5> CMD_RecipeID_Valid_Off() : RecipeID 검증 요청 처리
        .6> CMD_Grade_Req_Off() : Cell Grade 요청 처리
        .7> CMD_EQP_Data_Down_Off() : DaaType 을 읽어낸 후 처리
        
        .8> CMD_RecipeID_OK_On() : RecipeID 검증 완료 처리
        .9> CMD_Cell_Out_OK_On() : 강제 셀 배출 요청 완료 처리 
        .10> CMD_Host_Trouble_On() : Host 장애시 set 처리
        .11> CMD_Host_Data_Down_On() : Host 에서 데이터 내릴 시 set 처리
        .12> CMD_Host_Recipe_Req_On() : Recipe 갱신 요청 set 처리
    
    3> DSFPLC.DoCommand() : cmd 처리 메인 함수. - 번호 순으로 로직 처리
        .1> Chk_EQPPower
        .2> Chk_EQPStatus 
        .3> EQP_Bit_Type On 확인 후 처리 로직 실행
        
    4> DSFPLC.AliveCheck_SameWord_Off() : 3초에 한번씩 EQ 의 aliveBit 를 off 하는 쓰레드 함수
           
    5> DSFPLC.InitMemoryMap() : 메모리맵 주소 연동 변수 선언 함수

    6> DSFPLC.PLC_READER_ThreadFunc() : 500ms 마다 PLC 전체 메모리맵을 Read 하는 Thread

    7> DSFPLC.UpdateUI_PLC() : UI를 업데이트 하며, DoCommand() 가 결국 호출된다.
        .1> 국련에서는 MCStatusWord.CurrWord 의 assign 시점에 이벤트가 발생하여 DoCommand() 를 호출하게 된다.
        .2> DSFPLC 는 단지 MCStatusWord 의 array 로 처리한다.

    8> DSFPLC.UsePLC() : PLC_READER_ThreadFunc 쓰레드 생성 / 제거 함수.

    9> DSFPLC.MCStatusBitChangedEventListener() : EQP쪽 BitType 변경 이벤트 리스너
        .1> MELSEC.PLC 에서 제공하는 것은 연결 정보 뿐이다.
        .2> 이 리스너는 UI-Form 과 PLC_READER_ThreadFunc 에 의해
            CurrWord 값이 설정될 때 호출된다.

    10> DSFPLC.UpdateFlag() : BitType 업데이트 flag(On/Off) 함수.
    
    11> 기타
        .1> Host Recipe 변경/갱신/수정 catch 하여 EQP 로 내려주는 로직 필요
            - DSF & EOL 의 Recipee 관리 정책에 따라 달라질 수 있다.
            - 만약 필요하다면, DSFSch 가 Rest 를 열어놓는 방법이 있다


